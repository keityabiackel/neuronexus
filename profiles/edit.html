<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Editar Perfil Â· NeuroNexus</title>
<link rel="stylesheet" href="../assets/app.css" />
</head>
<body>

<main class="wrap">
  <header class="header">
    <div class="brandline">
      <div class="brandtext">
        <h1>NEURONEXUS</h1>
        <p>Perfil Â· taxonomia v1.0</p>
      </div>
    </div>
    <nav class="nav">
      <a class="btn" href="./index.html">â† Voltar</a>
      <a class="btn" href="../clans/index.html">ğŸ¡ ClÃ£s</a>
      <a class="btn" href="../index.html">ğŸ  Estado da Casa</a>
    </nav>
  </header>

  <h2>Perfil Neurodivergente</h2>

  <!-- DADOS -->
  <section class="card">
    <div class="grid2">
      <div class="field">
        <label>Nome</label>
        <input id="name" placeholder="Ex.: Keity" />
      </div>
      <div class="field">
        <label>Data de nascimento</label>
        <input id="birthDate" type="date" />
      </div>
    </div>
  </section>

  <!-- CAMADA 1 -->
  <section class="card">
    <h3>ğŸ§  Camada 1 â€” Neurotipo-base (mÃºltipla seleÃ§Ã£o)</h3>
    <div class="gridChecks" id="baseGrid"></div>

    <div class="grid2" style="margin-top:12px">
      <div class="field">
        <label>Status (geral)</label>
        <select id="baseStatus">
          <option value="confirmado">Confirmado</option>
          <option value="suspeita">Suspeita / Em avaliaÃ§Ã£o</option>
        </select>
      </div>
      <div class="field">
        <label>NÃ­vel atual de suporte</label>
        <select id="support">
          <option value="nao_informado">NÃ£o informado</option>
          <option value="baixo">Baixo</option>
          <option value="moderado">Moderado</option>
          <option value="alto">Alto</option>
          <option value="flutuante">Flutuante</option>
        </select>
      </div>
    </div>

    <div class="field" style="margin-top:12px">
      <label>ObservaÃ§Ãµes funcionais (curtas)</label>
      <input id="observations" placeholder="Ex.: varia muito por contexto; sensorial alto em mercado" />
    </div>
  </section>

  <!-- CAMADA 2 -->
  <section class="card">
    <h3>ğŸ§© Camada 2 â€” Perfis neurocognitivos associados</h3>

    <h4>EmoÃ§Ã£o, consciÃªncia e self</h4>
    <div class="gridChecks" id="l2a"></div>

    <h4>Sensorial e motor</h4>
    <div class="gridChecks" id="l2b"></div>

    <h4>Linguagem, leitura e escrita</h4>
    <div class="gridChecks" id="l2c"></div>
  </section>

  <!-- CAMADA 3 -->
  <section class="card">
    <h3>ğŸ§  Camada 3 â€” CondiÃ§Ãµes neurolÃ³gicas associadas</h3>
    <div class="gridChecks" id="l3"></div>
  </section>

  <!-- CAMADA 4 -->
  <section class="card">
    <h3>ğŸ§  Camada 4 â€” CondiÃ§Ãµes psiquiÃ¡tricas como comorbidade</h3>
    <h4>Espectro psicÃ³tico (como comorbidade)</h4>
    <div class="gridChecks" id="l4a"></div>

    <h4>Outros transtornos psiquiÃ¡tricos associados</h4>
    <div class="gridChecks" id="l4b"></div>
  </section>

  <button class="btn primary" id="save">Salvar perfil</button>
</main>

<script type="module">
import { TAXONOMY, defaultPerson, getPerson, upsertPerson } from "../assets/app.js";

const qs = new URLSearchParams(location.search);
const id = qs.get("id");

let person = id ? (getPerson(id) || defaultPerson()) : defaultPerson();

const $ = (id)=>document.getElementById(id);

function addChecks(container, items, selectedKeys){
  container.innerHTML = "";
  items.forEach(([key,label])=>{
    const wrap = document.createElement("label");
    wrap.className = "check";
    wrap.innerHTML = `
      <input type="checkbox" value="${key}">
      <span>${label}</span>
    `;
    const input = wrap.querySelector("input");
    input.checked = selectedKeys.includes(key);
    container.appendChild(wrap);
  });
}

function addBaseChecks(container, baseItems, selectedKeys){
  container.innerHTML = "";
  baseItems.forEach(({key,label})=>{
    const wrap = document.createElement("label");
    wrap.className = "check";
    wrap.innerHTML = `
      <input type="checkbox" value="${key}">
      <span>${label}</span>
    `;
    const input = wrap.querySelector("input");
    input.checked = selectedKeys.includes(key);
    container.appendChild(wrap);
  });

  // Regra: se "neurotipico" for marcado, desmarca os outros automaticamente.
  container.addEventListener("change", (e)=>{
    if(e.target && e.target.matches('input[type="checkbox"]')){
      const all = [...container.querySelectorAll('input[type="checkbox"]')];
      const nt = all.find(x=>x.value==="neurotipico");
      if(e.target.value==="neurotipico" && nt.checked){
        all.forEach(x=>{ if(x.value!=="neurotipico") x.checked=false; });
      }
      if(e.target.value!=="neurotipico" && e.target.checked){
        if(nt) nt.checked=false;
      }
    }
  });
}

function readChecked(container){
  return [...container.querySelectorAll('input[type="checkbox"]:checked')].map(x=>x.value);
}

function fill(){
  $("name").value = person.name || "";
  $("birthDate").value = person.birthDate || "";
  $("baseStatus").value = person.neuro.baseStatus || "confirmado";
  $("support").value = person.neuro.supportLevel || "nao_informado";
  $("observations").value = person.neuro.observations || "";

  addBaseChecks($("baseGrid"), TAXONOMY.layer1_base, person.neuro.baseTypes || ["neurotipico"]);

  addChecks($("l2a"), TAXONOMY.layer2.emocao_self, person.neuro.layer2 || []);
  addChecks($("l2b"), TAXONOMY.layer2.sensorial_motor, person.neuro.layer2 || []);
  addChecks($("l2c"), TAXONOMY.layer2.linguagem, person.neuro.layer2 || []);

  addChecks($("l3"), TAXONOMY.layer3, person.neuro.layer3 || []);

  addChecks($("l4a"), TAXONOMY.layer4.psicoticos, person.neuro.layer4 || []);
  addChecks($("l4b"), TAXONOMY.layer4.outros, person.neuro.layer4 || []);
}

$("save").onclick = ()=>{
  person.name = $("name").value.trim();
  person.birthDate = $("birthDate").value;
  person.neuro.baseTypes = readChecked($("baseGrid"));
  if(!person.neuro.baseTypes.length) person.neuro.baseTypes = ["neurotipico"];

  person.neuro.baseStatus = $("baseStatus").value;
  person.neuro.supportLevel = $("support").value;
  person.neuro.observations = $("observations").value.trim();

  const l2 = [
    ...readChecked($("l2a")),
    ...readChecked($("l2b")),
    ...readChecked($("l2c")),
  ];
  person.neuro.layer2 = [...new Set(l2)];

  person.neuro.layer3 = readChecked($("l3"));

  const l4 = [
    ...readChecked($("l4a")),
    ...readChecked($("l4b")),
  ];
  person.neuro.layer4 = [...new Set(l4)];

  if(!person.name){
    alert("Nome Ã© obrigatÃ³rio.");
    return;
  }

  upsertPerson(person);
  location.href = "./index.html";
};

fill();
</script>
</body>
</html>
