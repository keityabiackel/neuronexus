<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Editar perfil ¬∑ NeuroNexus</title>

  <!-- Fontes -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Roboto+Slab:wght@700;800&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="../assets/app.css" />
</head>
<body>
  <main class="wrap">
    <header class="header">
      <div class="brandline">
        <div class="logo">
          <img src="../assets/logo.png" alt="Logo NeuroNexus" />
        </div>
        <div class="brandtext">
          <h1>NEURONEXUS</h1>
          <p>Perfis do Cl√£ ¬∑ dados fixos, semipermanentes e hist√≥rico</p>
        </div>
      </div>

      <nav class="nav">
        <a class="btn" href="./index.html">üë• Perfis</a>
        <a class="btn" href="../index.html">üè† Estado da Casa</a>
      </nav>
    </header>

    <div class="topbar">
      <div class="brand">
        <h1 id="title">Novo perfil</h1>
        <p>Dados fixos + semipermanentes. Eventos ficam no hist√≥rico (timestamp).</p>
      </div>
    </div>

    <!-- Fixos -->
    <section class="card">
      <div class="grid2">
        <div class="field">
          <label for="name">Nome</label>
          <input id="name" placeholder="Ex.: Leon Caleb" />
        </div>
        <div class="field">
          <label for="birthDate">Data de nascimento</label>
          <input id="birthDate" type="date" />
        </div>
        <div class="field">
          <label for="role">Papel</label>
          <select id="role">
            <option value="membro">membro</option>
            <option value="crian√ßa">crian√ßa</option>
            <option value="respons√°vel">respons√°vel</option>
            <option value="cuidador">cuidador</option>
            <option value="parceiro-escola">parceiro-escola</option>
            <option value="profissional-saude">profissional-saude</option>
          </select>
        </div>
        <div class="field">
          <label for="notes">Notas operacionais</label>
          <input id="notes" placeholder="Ex.: comunica√ß√£o preferida, sinais de sobrecarga..." />
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <button class="btn primary" id="save" type="button">Salvar</button>
        <button class="btn" id="setActive" type="button">Tornar ativo</button>
      </div>
    </section>

    <!-- Neurotipos -->
    <h2 style="margin:16px 0 10px">üß† Neurotipos e Camadas Associadas</h2>
    <section class="card">
      <p class="small" style="margin-top:0">
        Selecione itens do mosaico e registre apenas o necess√°rio: <strong>status</strong>, <strong>desde</strong> e <strong>nota operacional</strong>.
        (Leituras/explica√ß√µes por item entram depois.)
      </p>

      <table class="table" style="margin-top:10px">
        <thead>
          <tr>
            <th>Grupo</th>
            <th>Item</th>
            <th>Selecionado</th>
            <th>Status</th>
            <th>Desde</th>
            <th>Notas</th>
          </tr>
        </thead>
        <tbody id="neuroRows"></tbody>
      </table>

      <p class="hint">
        ‚ÄúBase‚Äù pode existir sozinho e organiza o funcionamento global. ‚ÄúCamadas‚Äù modulam. ‚ÄúCombina√ß√µes‚Äù descrevem estruturas como 2e.
      </p>
    </section>

    <!-- Alergias -->
    <h2 style="margin:16px 0 10px">Alergias (semipermanentes)</h2>
    <section class="card">
      <div class="row">
        <div class="field" style="flex:1; min-width:240px">
          <label for="allergyLabel">Nova alergia</label>
          <input id="allergyLabel" placeholder="Ex.: sangue, dipirona, amendoim..." />
        </div>
        <div class="field" style="flex:1; min-width:240px">
          <label for="allergyNotes">Notas (opcional)</label>
          <input id="allergyNotes" placeholder="Ex.: rea√ß√£o grave em transfus√£o..." />
        </div>
        <button class="btn primary" id="addAllergy" type="button">Adicionar</button>
      </div>

      <table class="table" style="margin-top:12px">
        <thead>
          <tr>
            <th>Ativo</th>
            <th>Item</th>
            <th>Desde</th>
            <th>Notas</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="allergyRows"></tbody>
      </table>

      <p class="hint">Nada some: pode ficar inativo se deixar de ser relevante.</p>
    </section>
  </main>

  <script type="module">
    import {
      uid, nowIso,
      loadProfiles, upsertProfile,
      loadActiveProfileId, setActiveProfileId
    } from "../assets/app.js";

    const params = new URLSearchParams(location.search);
    const id = params.get("id");

    const title = document.getElementById("title");
    const name = document.getElementById("name");
    const birthDate = document.getElementById("birthDate");
    const role = document.getElementById("role");
    const notes = document.getElementById("notes");

    const allergyLabel = document.getElementById("allergyLabel");
    const allergyNotes = document.getElementById("allergyNotes");
    const allergyRows = document.getElementById("allergyRows");

    const neuroRows = document.getElementById("neuroRows");

    let current = null;

    const NEURO_BASE = [
      { key: "autismo", label: "Autismo (TEA)" },
      { key: "tdah", label: "TDAH" },
      { key: "superdotacao", label: "Superdota√ß√£o / Altas Habilidades" },
      { key: "afantasia", label: "Afantasia" },
      { key: "tourette", label: "Tourette" }
    ];

    const NEURO_LAYERS = [
      { key: "dislexia", label: "Dislexia", group: "Aprendizagem" },
      { key: "discalculia", label: "Discalculia", group: "Aprendizagem" },
      { key: "disgrafia", label: "Disgrafia", group: "Aprendizagem" },
      { key: "hiperlexia", label: "Hiperlexia", group: "Aprendizagem" },
      { key: "tpac", label: "TPAC / DPAC", group: "Processamento e execu√ß√£o" },
      { key: "dispraxia", label: "Dispraxia (Transtorno do Desenvolvimento da Coordena√ß√£o)", group: "Processamento e execu√ß√£o" },
      { key: "toc", label: "TOC", group: "Emo√ß√£o e regula√ß√£o" },
      { key: "ansiedade", label: "Transtornos de Ansiedade", group: "Emo√ß√£o e regula√ß√£o" }
    ];

    const NEURO_COMBINATIONS = [
      { key: "2e_autismo_superdotacao", label: "Dupla excepcionalidade (Autismo + Superdota√ß√£o)" },
      { key: "2e_tdah_superdotacao", label: "Dupla excepcionalidade (TDAH + Superdota√ß√£o)" },
      { key: "2e_autismo_tdah", label: "Dupla excepcionalidade (Autismo + TDAH)" },
      { key: "2e_outra", label: "Dupla excepcionalidade (Outra combina√ß√£o)" }
    ];

    const STATUS_OPTIONS = [
      { value: "confirmado", label: "confirmado" },
      { value: "hipotese", label: "hip√≥tese" },
      { value: "traco", label: "tra√ßo" },
      { value: "historico", label: "hist√≥rico" }
    ];

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function escapeAttr(str){
      return String(str || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function ensureNeuroShape(){
      current.neuro = current.neuro || { base: [], layers: [], combinations: [] };
      current.neuro.base = Array.isArray(current.neuro.base) ? current.neuro.base : [];
      current.neuro.layers = Array.isArray(current.neuro.layers) ? current.neuro.layers : [];
      current.neuro.combinations = Array.isArray(current.neuro.combinations) ? current.neuro.combinations : [];
    }

    function getNeuroList(category){
      if (category === "base") return current.neuro.base;
      if (category === "layers") return current.neuro.layers;
      return current.neuro.combinations;
    }

    function findNeuro(category, key){
      return getNeuroList(category).find(x => x.key === key) || null;
    }

    function setNeuroChecked(category, item, checked){
      const list = getNeuroList(category);
      const exists = findNeuro(category, item.key);

      if (checked && !exists){
        const payload = { key: item.key, label: item.label, status: "hipotese", since: "", notes: "" };
        if (category === "layers") payload.group = item.group || "";
        list.push(payload);
      }

      if (!checked && exists){
        const next = list.filter(x => x.key !== item.key);
        if (category === "base") current.neuro.base = next;
        else if (category === "layers") current.neuro.layers = next;
        else current.neuro.combinations = next;
      }
    }

    function updateNeuroField(category, key, patch){
      const obj = findNeuro(category, key);
      if (!obj) return;
      Object.assign(obj, patch);
    }

    function statusSelectHtml(selected){
      return STATUS_OPTIONS.map(o =>
        `<option value="${o.value}" ${o.value === selected ? "selected" : ""}>${o.label}</option>`
      ).join("");
    }

    function renderNeuro(){
      ensureNeuroShape();
      neuroRows.innerHTML = "";

      const allRows = [
        ...NEURO_BASE.map(i => ({ category:"base", group:"Base", ...i })),
        ...NEURO_LAYERS.map(i => ({ category:"layers", group:i.group, ...i })),
        ...NEURO_COMBINATIONS.map(i => ({ category:"combinations", group:"Combina√ß√µes", ...i }))
      ];

      for (const item of allRows){
        const obj = findNeuro(item.category, item.key);
        const checked = !!obj;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(item.group || "")}</td>
          <td>${escapeHtml(item.label || "")}</td>
          <td><input type="checkbox" data-nchk="${item.category}:${item.key}" ${checked ? "checked" : ""} /></td>
          <td><select data-nstatus="${item.category}:${item.key}" ${checked ? "" : "disabled"}>${statusSelectHtml(obj?.status || "hipotese")}</select></td>
          <td><input type="date" data-nsince="${item.category}:${item.key}" value="${escapeAttr(obj?.since || "")}" ${checked ? "" : "disabled"} /></td>
          <td><input type="text" data-nnotes="${item.category}:${item.key}" value="${escapeAttr(obj?.notes || "")}" placeholder="nota operacional" ${checked ? "" : "disabled"} /></td>
        `;
        neuroRows.appendChild(tr);
      }

      neuroRows.querySelectorAll("[data-nchk]").forEach(el=>{
        el.addEventListener("change", ()=>{
          const [category, key] = el.getAttribute("data-nchk").split(":");
          const item =
            category === "base" ? NEURO_BASE.find(x=>x.key===key)
            : category === "layers" ? NEURO_LAYERS.find(x=>x.key===key)
            : NEURO_COMBINATIONS.find(x=>x.key===key);

          setNeuroChecked(category, item, el.checked);
          persist();
          renderNeuro();
        });
      });

      neuroRows.querySelectorAll("[data-nstatus]").forEach(el=>{
        el.addEventListener("change", ()=>{
          const [category, key] = el.getAttribute("data-nstatus").split(":");
          updateNeuroField(category, key, { status: el.value });
          persist();
        });
      });

      neuroRows.querySelectorAll("[data-nsince]").forEach(el=>{
        el.addEventListener("change", ()=>{
          const [category, key] = el.getAttribute("data-nsince").split(":");
          updateNeuroField(category, key, { since: el.value });
          persist();
        });
      });

      neuroRows.querySelectorAll("[data-nnotes]").forEach(el=>{
        el.addEventListener("input", ()=>{
          const [category, key] = el.getAttribute("data-nnotes").split(":");
          updateNeuroField(category, key, { notes: el.value });
          persist();
        });
      });
    }

    function renderAllergies(){
      allergyRows.innerHTML = "";
      const list = current.allergies || [];

      if (!list.length){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="5">Nenhuma alergia cadastrada.</td>`;
        allergyRows.appendChild(tr);
        return;
      }

      for (const a of list){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><button class="btn ${a.active ? "primary" : ""}" data-toggle="${a.id}">${a.active ? "Ativa" : "Inativa"}</button></td>
          <td>${escapeHtml(a.label || "")}</td>
          <td>${escapeHtml((a.startedAt || "").slice(0,10) || "‚Äî")}</td>
          <td>${escapeHtml(a.notes || "")}</td>
          <td><button class="btn danger" data-del="${a.id}">Remover</button></td>
        `;
        allergyRows.appendChild(tr);
      }

      allergyRows.querySelectorAll("[data-toggle]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const aid = btn.getAttribute("data-toggle");
          const a = current.allergies.find(x => x.id === aid);
          if (!a) return;
          a.active = !a.active;
          persist();
          renderAllergies();
        });
      });

      allergyRows.querySelectorAll("[data-del]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const aid = btn.getAttribute("data-del");
          if (!confirm("Remover este item?")) return;
          current.allergies = current.allergies.filter(x => x.id !== aid);
          persist();
          renderAllergies();
        });
      });
    }

    function loadCurrent(){
      const list = loadProfiles();
      current = id ? list.find(p => p.id === id) : null;

      if (!current){
        current = { id: uid("p"), name:"", birthDate:"", role:"membro", neuro:{base:[],layers:[],combinations:[]}, allergies:[], notes:"", createdAt: nowIso(), updatedAt: nowIso() };
        title.textContent = "Novo perfil";
      } else {
        title.textContent = "Editar perfil";
      }

      current.allergies = Array.isArray(current.allergies) ? current.allergies : [];
      ensureNeuroShape();

      name.value = current.name || "";
      birthDate.value = current.birthDate || "";
      role.value = current.role || "membro";
      notes.value = current.notes || "";

      renderNeuro();
      renderAllergies();
    }

    function persist(){
      current.name = name.value.trim();
      current.birthDate = birthDate.value;
      current.role = role.value;
      current.notes = notes.value.trim();

      ensureNeuroShape();
      current.allergies = Array.isArray(current.allergies) ? current.allergies : [];

      current = upsertProfile(current);
      return current;
    }

    document.getElementById("save").addEventListener("click", ()=>{
      persist();
      alert("Perfil salvo.");
      history.replaceState(null, "", "./edit.html?id=" + encodeURIComponent(current.id));
    });

    document.getElementById("setActive").addEventListener("click", ()=>{
      persist();
      setActiveProfileId(current.id);
      alert("Perfil ativo definido.");
    });

    document.getElementById("addAllergy").addEventListener("click", ()=>{
      const label = allergyLabel.value.trim();
      if (!label) return alert("Digite o nome da alergia.");
      const item = { id: uid("a"), label, notes: allergyNotes.value.trim(), startedAt: nowIso(), active: true };
      current.allergies.unshift(item);
      allergyLabel.value = "";
      allergyNotes.value = "";
      persist();
      renderAllergies();
    });

    loadCurrent();
  </script>
</body>
</html>
