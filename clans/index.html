<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cl√£s ¬∑ NeuroNexus</title>
<link rel="stylesheet" href="../assets/app.css" />
</head>

<body>
<main class="wrap">
  <header class="header">
    <div class="brandline">
      <div class="brandtext">
        <h1>NEURONEXUS</h1>
        <p>Cl√£s ¬∑ n√∫cleos familiares</p>
      </div>
    </div>
    <nav class="nav">
      <a class="btn" href="../index.html">üè† Estado da Casa</a>
      <a class="btn" href="../profiles/index.html">üë• Pessoas</a>
    </nav>
  </header>

  <!-- CRIAR CL√É -->
  <section class="card">
    <h2>Novo Cl√£</h2>
    <div class="grid2">
      <div class="field">
        <label>Nome do Cl√£</label>
        <input id="clanName" placeholder="Ex.: Casa da Mam√£e" />
      </div>
      <div class="field">
        <label>Respons√°vel</label>
        <input id="adminName" placeholder="Ex.: Keity" />
      </div>
    </div>
    <button class="btn primary" id="createClan">Criar Cl√£</button>
  </section>

  <!-- LISTA DE CL√ÉS -->
  <section class="card">
    <h2>Cl√£s existentes</h2>
    <table class="table">
      <thead>
        <tr>
          <th>Ativo</th>
          <th>Nome</th>
          <th>Respons√°vel</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="clanRows"></tbody>
    </table>
  </section>

  <!-- MEMBROS DO CL√É ATIVO -->
  <section class="card">
    <h2>Membros do Cl√£ Ativo</h2>
    <p class="small" id="activeClanLabel">‚Äî</p>

    <div class="grid2">
      <div>
        <h4>Adicionar pessoa existente</h4>
        <select id="personSelect"></select>
        <input id="roleInClan" placeholder="Papel no cl√£ (ex.: m√£e, filho, tia)" />
        <button class="btn" id="addMember">Adicionar</button>
      </div>

      <div>
        <h4>Membros atuais</h4>
        <ul id="memberList"></ul>
      </div>
    </div>
  </section>
</main>

<script type="module">
import {
  defaultClan, upsertClan, loadClans, deleteClan,
  loadPersons,
  loadActiveClanId, setActiveClanId,
  addMembership, removeMembership, membersOfClan
} from "../assets/app.js";

const clanRows = document.getElementById("clanRows");
const personSelect = document.getElementById("personSelect");
const memberList = document.getElementById("memberList");
const activeClanLabel = document.getElementById("activeClanLabel");

function renderClans(){
  const clans = loadClans();
  const activeId = loadActiveClanId();
  clanRows.innerHTML = "";

  clans.forEach(c=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>
        <button class="btn ${c.id===activeId?'primary':''}" data-active="${c.id}">
          ${c.id===activeId?'Ativo':'Ativar'}
        </button>
      </td>
      <td>${c.name}</td>
      <td>${c.adminName}</td>
      <td>
        <button class="btn danger" data-del="${c.id}">Excluir</button>
      </td>
    `;
    clanRows.appendChild(tr);
  });

  document.querySelectorAll("[data-active]").forEach(b=>{
    b.onclick = ()=>{
      setActiveClanId(b.dataset.active);
      render();
    };
  });

  document.querySelectorAll("[data-del]").forEach(b=>{
    b.onclick = ()=>{
      if(confirm("Excluir este cl√£?")){
        deleteClan(b.dataset.del);
        render();
      }
    };
  });
}

function renderPersons(){
  const persons = loadPersons();
  personSelect.innerHTML = `<option value="">Selecione</option>`;
  persons.forEach(p=>{
    const o = document.createElement("option");
    o.value = p.id;
    o.textContent = p.name;
    personSelect.appendChild(o);
  });
}

function renderMembers(){
  const clanId = loadActiveClanId();
  memberList.innerHTML = "";
  if(!clanId){
    activeClanLabel.textContent = "Nenhum cl√£ ativo.";
    return;
  }

  const members = membersOfClan(clanId);
  activeClanLabel.textContent = `Cl√£ ativo: ${loadClans().find(c=>c.id===clanId)?.name}`;

  members.forEach(m=>{
    const li = document.createElement("li");
    li.innerHTML = `
      ${m.person.name} (${m.membership.roleInClan || "‚Äî"})
      <button class="btn danger" data-rm="${m.person.id}">remover</button>
    `;
    memberList.appendChild(li);
  });

  document.querySelectorAll("[data-rm]").forEach(b=>{
    b.onclick = ()=>{
      removeMembership(clanId, b.dataset.rm);
      renderMembers();
    };
  });
}

document.getElementById("createClan").onclick = ()=>{
  const c = defaultClan();
  c.name = clanName.value.trim();
  c.adminName = adminName.value.trim();
  if(!c.name) return alert("Nome do cl√£ √© obrigat√≥rio");
  upsertClan(c);
  setActiveClanId(c.id);
  clanName.value = "";
  adminName.value = "";
  render();
};

document.getElementById("addMember").onclick = ()=>{
  const clanId = loadActiveClanId();
  const pid = personSelect.value;
  if(!clanId || !pid) return;
  addMembership(clanId, pid, roleInClan.value.trim());
  roleInClan.value = "";
  renderMembers();
};

function render(){
  renderClans();
  renderPersons();
  renderMembers();
}

render();
</script>
</body>
</html>
