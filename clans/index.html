<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cl√£s ¬∑ NeuroNexus</title>
<link rel="stylesheet" href="../assets/app.css" />
</head>

<body>
<main class="wrap">
  <header class="header">
    <div class="brandline">
      <div class="brandtext">
        <h1>NEURONEXUS</h1>
        <p>Cl√£s ¬∑ n√∫cleos familiares</p>
      </div>
    </div>
    <nav class="nav">
      <a class="btn" href="../index.html">üè† Estado da Casa</a>
      <a class="btn" href="../profiles/index.html">üë• Pessoas</a>
    </nav>
  </header>

  <section class="card">
    <h2>Novo Cl√£</h2>
    <div class="grid2">
      <div class="field">
        <label>Nome do cl√£</label>
        <input id="clanName" placeholder="Ex.: Casa da Mam√£e" />
      </div>
      <div class="field">
        <label>Respons√°vel</label>
        <input id="adminName" placeholder="Ex.: Keity" />
      </div>
    </div>
    <button class="btn primary" id="create">Criar cl√£</button>
  </section>

  <section class="card">
    <h2>Cl√£s existentes</h2>
    <table class="table">
      <thead>
        <tr>
          <th>Ativo</th>
          <th>Nome</th>
          <th>Respons√°vel</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </section>

  <section class="card">
    <h2>Membros do cl√£ ativo</h2>
    <p class="small" id="activeLabel">‚Äî</p>

    <div class="grid2">
      <div>
        <h4>Adicionar pessoa existente</h4>
        <select id="personSelect"></select>
        <input id="role" placeholder="Papel no cl√£ (ex.: m√£e, filho, av√≥)" />
        <button class="btn" id="add">Adicionar</button>
        <p class="small">Se a pessoa n√£o existe, crie em <a href="../profiles/index.html">Pessoas</a>.</p>
      </div>

      <div>
        <h4>Membros</h4>
        <ul id="members"></ul>
      </div>
    </div>
  </section>
</main>

<script type="module">
import {
  defaultClan, upsertClan, loadClans, deleteClan,
  loadPersons,
  loadActiveClanId, setActiveClanId,
  addMembership, removeMembership, membersOfClan
} from "../assets/app.js";

const rows = document.getElementById("rows");
const personSelect = document.getElementById("personSelect");
const membersUl = document.getElementById("members");
const activeLabel = document.getElementById("activeLabel");

function ensureActiveClan(){
  const clans = loadClans();
  if(!clans.length) return null;
  let activeId = loadActiveClanId();
  let active = clans.find(c=>c.id===activeId) || clans[0];
  setActiveClanId(active.id);
  return active;
}

function renderClans(){
  const clans = loadClans();
  const activeId = loadActiveClanId();
  rows.innerHTML = "";

  clans.forEach(c=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><button class="btn ${c.id===activeId?'primary':''}" data-act="${c.id}">
        ${c.id===activeId?'Ativo':'Ativar'}
      </button></td>
      <td>${c.name || "‚Äî"}</td>
      <td>${c.adminName || "‚Äî"}</td>
      <td>
        <button class="btn danger" data-del="${c.id}">Excluir</button>
      </td>
    `;
    rows.appendChild(tr);
  });

  document.querySelectorAll("[data-act]").forEach(b=>{
    b.onclick = ()=>{
      setActiveClanId(b.dataset.act);
      render();
    };
  });

  document.querySelectorAll("[data-del]").forEach(b=>{
    b.onclick = ()=>{
      if(confirm("Excluir este cl√£? (remove v√≠nculos e estado associado)")){
        deleteClan(b.dataset.del);
        render();
      }
    };
  });
}

function renderPersons(){
  const persons = loadPersons();
  personSelect.innerHTML = `<option value="">Selecione</option>`;
  persons.forEach(p=>{
    const o = document.createElement("option");
    o.value = p.id;
    o.textContent = p.name;
    personSelect.appendChild(o);
  });
}

function renderMembers(){
  const active = ensureActiveClan();
  membersUl.innerHTML = "";

  if(!active){
    activeLabel.textContent = "Nenhum cl√£ cadastrado ainda.";
    return;
  }
  activeLabel.textContent = `Cl√£ ativo: ${active.name}`;

  const ms = membersOfClan(active.id);
  ms.forEach(x=>{
    const li = document.createElement("li");
    li.innerHTML = `
      ${x.person.name} <span class="small">(${x.membership.roleInClan || "‚Äî"})</span>
      <button class="btn danger" data-rm="${x.person.id}">remover</button>
    `;
    membersUl.appendChild(li);
  });

  document.querySelectorAll("[data-rm]").forEach(b=>{
    b.onclick = ()=>{
      removeMembership(active.id, b.dataset.rm);
      renderMembers();
    };
  });
}

document.getElementById("create").onclick = ()=>{
  const c = defaultClan();
  c.name = document.getElementById("clanName").value.trim();
  c.adminName = document.getElementById("adminName").value.trim();
  if(!c.name) return alert("Nome do cl√£ √© obrigat√≥rio.");
  upsertClan(c);
  setActiveClanId(c.id);
  document.getElementById("clanName").value = "";
  document.getElementById("adminName").value = "";
  render();
};

document.getElementById("add").onclick = ()=>{
  const active = ensureActiveClan();
  const pid = personSelect.value;
  const role = document.getElementById("role").value.trim();
  if(!active) return alert("Crie um cl√£ primeiro.");
  if(!pid) return alert("Selecione uma pessoa.");
  addMembership(active.id, pid, role);
  document.getElementById("role").value = "";
  renderMembers();
};

function render(){
  ensureActiveClan();
  renderClans();
  renderPersons();
  renderMembers();
}

render();
</script>
</body>
</html>
