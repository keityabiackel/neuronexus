<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NeuroNexus â€” Estado da Casa</title>
  <link rel="stylesheet" href="assets/app.css" />
</head>

<body data-state="NONE">
  <div class="wrap">
    <header class="header">
      <div class="brand">
        <!-- troque depois pelo logo do NeuroNexus (mesma estÃ©tica do PRISMAS) -->
        <img src="assets/logo.png" alt="Logo" onerror="this.style.display='none'">
        <div>
          <div class="title">NEURONEXUS</div>
          <div class="subtitle">MVP Fase 0 Â· sem backend</div>
        </div>
      </div>

      <nav class="nav">
        <a class="btn" href="clans/index.html">ğŸ  ClÃ£s</a>
        <a class="btn" href="profiles/index.html">ğŸ‘¥ Membros do ClÃ£</a>
      </nav>
    </header>

    <section class="card">
      <h2>Estado da Casa</h2>
      <div class="small">
        Um indicador compartilhado e acionÃ¡vel do estado do ambiente domÃ©stico.
        Menos interpretaÃ§Ã£o; mais dados observÃ¡veis.
      </div>

      <div class="stateRow">
        <div class="stateLeft">
          <div class="dot" aria-hidden="true"></div>
          <div class="stamp" aria-hidden="true" title="Estampa do estado (acessibilidade)"></div>
          <div class="stateText">
            Estado: <span id="stateLabel">â€”</span>
          </div>
        </div>

        <div class="stateMeta">
          <div>Atualizado em: <span id="updatedAt">â€”</span></div>
          <div>ClÃ£: <span id="clanLabel">â€”</span></div>
        </div>
      </div>

      <div class="actions">
        <button class="btn" id="btnGreen" type="button">ğŸŸ¢ VERDE</button>
        <button class="btn" id="btnYellow" type="button">ğŸŸ¡ AMARELO</button>
        <button class="btn" id="btnRed" type="button">ğŸ”´ VERMELHO</button>
        <button class="btn danger" id="btnClear" type="button">Limpar estado</button>
      </div>

      <div class="small" style="margin-top:10px">
        Acessibilidade: alÃ©m de cor, cada estado tem uma â€œestampaâ€ (pontilhado / listras / hatch) + texto.
        Atalhos: 1 (Verde), 2 (Amarelo), 3 (Vermelho).
      </div>
      <div class="small" style="margin-top:6px">
        Este MVP salva apenas no seu navegador (LocalStorage). Nada Ã© enviado para lugar nenhum.
        Enquanto vocÃª nÃ£o cria um ClÃ£, o estado fica em â€œSem clÃ£â€. Depois, passa a funcionar por ClÃ£ automaticamente.
      </div>
    </section>

    <section class="card">
      <h2>Do semÃ¡foro para a evidÃªncia</h2>
      <div class="small">
        Ã€s vezes a gente nÃ£o â€œdefineâ€ o estado â€” a gente <b>descobre</b>.
        PrÃ³ximo passo: sinais observÃ¡veis (sono, ingestÃ£o, dor, estÃ­mulo, rotina, episÃ³dios com timestamp)
        para sugerir o estado com base em evidÃªncias.
      </div>
    </section>

    <section class="card">
      <h2>NÃ£o entendi nada!</h2>
      <div class="small">Escolha o nÃ­vel de ajuda que vocÃª quer agora.</div>
      <div class="gridHelp" style="margin-top:10px">
        <a class="btn primary" href="help/resumo.html">me faz um resumo</a>
        <a class="btn" href="help/explicar.html">me explique direito</a>
      </div>
    </section>
  </div>

<script>
/* ==========================
   Estado da Casa (MVP)
   - persiste por ClÃ£ (se existir)
   - fallback "global" se ainda nÃ£o houver clÃ£
   ========================== */

const LS_ACTIVE_CLAN = "nn_activeClanId";
const LS_CLANS       = "nn_clans";
const LS_HOUSE       = "nn_houseState"; // global
const LS_HOUSE_BY    = "nn_houseStateByClan"; // map por clÃ£

function nowISO(){
  return new Date().toISOString();
}

function fmt(ts){
  if(!ts) return "â€”";
  try{
    const d = new Date(ts);
    return d.toLocaleString("pt-BR");
  }catch{ return ts; }
}

function loadJSON(key, fallback){
  try{
    const raw = localStorage.getItem(key);
    return raw ? JSON.parse(raw) : fallback;
  }catch{
    return fallback;
  }
}
function saveJSON(key, value){
  localStorage.setItem(key, JSON.stringify(value));
}

function getActiveClan(){
  const clans = loadJSON(LS_CLANS, []);
  if(!clans.length) return null;
  const activeId = localStorage.getItem(LS_ACTIVE_CLAN);
  return clans.find(c=>c.id===activeId) || clans[0];
}

function getHouseKey(){
  const clan = getActiveClan();
  return clan ? clan.id : null;
}

function readHouse(){
  const clanId = getHouseKey();
  if(!clanId){
    return loadJSON(LS_HOUSE, { state:"NONE", updatedAt:null });
  }
  const map = loadJSON(LS_HOUSE_BY, {});
  return map[clanId] || { state:"NONE", updatedAt:null };
}

function writeHouse(state){
  const clanId = getHouseKey();
  const payload = { state, updatedAt: nowISO() };

  if(!clanId){
    saveJSON(LS_HOUSE, payload);
  }else{
    const map = loadJSON(LS_HOUSE_BY, {});
    map[clanId] = payload;
    saveJSON(LS_HOUSE_BY, map);
  }
  render();
}

function clearHouse(){
  const clanId = getHouseKey();
  if(!clanId){
    localStorage.removeItem(LS_HOUSE);
  }else{
    const map = loadJSON(LS_HOUSE_BY, {});
    delete map[clanId];
    saveJSON(LS_HOUSE_BY, map);
  }
  render();
}

function render(){
  const clan = getActiveClan();
  const house = readHouse();

  document.body.setAttribute("data-state", house.state || "NONE");
  document.getElementById("stateLabel").textContent =
    (house.state==="GREEN") ? "VERDE" :
    (house.state==="YELLOW") ? "AMARELO" :
    (house.state==="RED") ? "VERMELHO" : "â€”";

  document.getElementById("updatedAt").textContent = fmt(house.updatedAt);
  document.getElementById("clanLabel").textContent = clan ? (clan.name || "â€”") : "Sem clÃ£";
}

function bind(){
  document.getElementById("btnGreen").onclick  = ()=>writeHouse("GREEN");
  document.getElementById("btnYellow").onclick = ()=>writeHouse("YELLOW");
  document.getElementById("btnRed").onclick    = ()=>writeHouse("RED");
  document.getElementById("btnClear").onclick  = ()=>clearHouse();

  document.addEventListener("keydown", (e)=>{
    if(e.target && ["INPUT","TEXTAREA","SELECT"].includes(e.target.tagName)) return;
    if(e.key==="1") writeHouse("GREEN");
    if(e.key==="2") writeHouse("YELLOW");
    if(e.key==="3") writeHouse("RED");
  });
}

bind();
render();
</script>
</body>
</html>
