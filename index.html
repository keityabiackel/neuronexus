<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NeuroNexus Hub</title>
  <link rel="stylesheet" href="./assets/app.css" />
</head>
<body>
  <main class="wrap">
    <div class="topbar">
      <div class="brand">
        <h1>NeuroNexus Hub</h1>
        <p>MVP Fase 0 â€” Estado da Casa (B). Menos interpretaÃ§Ã£o; mais dados observÃ¡veis.</p>
      </div>
      <nav class="nav">
        <div class="chip" id="hubChip">Hub: â€”</div>
        <div class="chip" id="activeChip">Ativo: â€”</div>
        <a class="btn" href="./profiles/index.html">ðŸ‘¤ Perfis</a>
        <a class="btn" href="./events/index.html">ðŸ§¾ Eventos</a>
      </nav>
    </div>

    <section class="card row" aria-label="Estado atual da casa">
      <div class="pill">
        <span class="dot" id="dot"></span>
        <span>Estado da Casa:</span>
        <span id="stateLabel">INDEFINIDO</span>
      </div>
      <div class="small" id="timestamp">â€”</div>
    </section>

    <section class="grid3" aria-label="Controles de estado">
      <button class="statebtn green" id="btnGreen" type="button">ðŸŸ¢ VERDE</button>
      <button class="statebtn yellow" id="btnYellow" type="button">ðŸŸ¡ AMARELO</button>
      <button class="statebtn red" id="btnRed" type="button">ðŸ”´ VERMELHO</button>
    </section>

    <p class="hint">
      Atalhos: <strong>1</strong> Verde, <strong>2</strong> Amarelo, <strong>3</strong> Vermelho.
      <br/>Tudo Ã© salvo localmente (LocalStorage). Nada Ã© enviado.
    </p>

    <div class="row" style="margin-top:12px">
      <button class="btn ghost" id="btnClear" type="button">Limpar estado</button>
      <span class="small">client-side Â· sem backend</span>
    </div>
  </main>

  <script type="module">
    import {
      loadHub, loadProfiles, loadActiveProfileId,
      loadHouse, saveHouse, clearHouse,
      normalizeState, formatWhen
    } from "./assets/app.js";

    const dot = document.getElementById("dot");
    const stateLabel = document.getElementById("stateLabel");
    const ts = document.getElementById("timestamp");
    const hubChip = document.getElementById("hubChip");
    const activeChip = document.getElementById("activeChip");

    function labelFor(state){
      if (state === "GREEN") return "VERDE";
      if (state === "YELLOW") return "AMARELO";
      if (state === "RED") return "VERMELHO";
      return "INDEFINIDO";
    }

    function applyBodyState(state){
      document.body.classList.remove("state-GREEN","state-YELLOW","state-RED");
      if (state) document.body.classList.add("state-"+state);
      dot.className = "dot " + (state === "GREEN" ? "G" : state === "YELLOW" ? "Y" : state === "RED" ? "R" : "");
    }

    function renderHouse(data){
      const s = normalizeState(data?.state);
      applyBodyState(s);
      stateLabel.textContent = labelFor(s);
      ts.textContent = data?.updatedAt ? ("Atualizado em: " + formatWhen(data.updatedAt)) : "â€”";
    }

    function renderHeader(){
      const hub = loadHub();
      hubChip.textContent = "Hub: " + (hub.hubName?.trim() || "(nÃ£o configurado)");

      const profiles = loadProfiles();
      const activeId = loadActiveProfileId();
      const active = profiles.find(p => p.id === activeId);
      activeChip.textContent = "Ativo: " + (active?.name?.trim() || hub.adminName?.trim() || "(ninguÃ©m)");
    }

    function setState(s){
      const saved = saveHouse(s);
      renderHouse(saved);
    }

    // init
    renderHeader();
    renderHouse(loadHouse());

    document.getElementById("btnGreen").addEventListener("click", ()=>setState("GREEN"));
    document.getElementById("btnYellow").addEventListener("click", ()=>setState("YELLOW"));
    document.getElementById("btnRed").addEventListener("click", ()=>setState("RED"));
    document.getElementById("btnClear").addEventListener("click", ()=>{ clearHouse(); renderHouse(null); });

    window.addEventListener("keydown",(e)=>{
      if (e.key === "1") setState("GREEN");
      if (e.key === "2") setState("YELLOW");
      if (e.key === "3") setState("RED");
    });
  </script>
</body>
</html>
