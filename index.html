<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NeuroNexus Â· Estado da Casa</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Roboto+Slab:wght@700;800&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="./assets/app.css" />
</head>
<body>
  <main class="wrap">
    <header class="header">
      <div class="brandline">
        <div class="logo">
          <img src="./assets/logo.png" alt="Logo NeuroNexus" />
        </div>
        <div class="brandtext">
          <h1>NEURONEXUS</h1>
          <p id="sub">MVP Fase 0 Â· sem backend</p>
        </div>
      </div>

      <nav class="nav">
        <a class="btn" href="./clans/index.html">ğŸ¡ ClÃ£s</a>
        <a class="btn" href="./profiles/index.html">ğŸ‘¥ Membros do ClÃ£</a>
      </nav>
    </header>

    <section class="card">
      <div class="topbar">
        <div class="brand">
          <h2>Estado da Casa</h2>
          <p>
            Um indicador compartilhado e acionÃ¡vel do estado do ambiente domÃ©stico.
            Menos interpretaÃ§Ã£o; mais dados observÃ¡veis.
          </p>
        </div>
        <div class="small" id="updated">â€”</div>
      </div>

      <!-- Badge com cor + texto + estampa -->
      <div class="stateBadge" id="badge" data-s="YELLOW" role="status" aria-live="polite" style="margin:12px 0">
        <div class="stateLeft">
          <span class="stateIcon" aria-hidden="true"></span>
          <span class="statePattern" aria-hidden="true"></span>
          <span>Estado: <span class="stateText" id="label">â€”</span></span>
        </div>
        <div class="small" id="clanName">ClÃ£: â€”</div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn" id="green" title="Atalho: 1">ğŸŸ¢ VERDE</button>
        <button class="btn" id="yellow" title="Atalho: 2">ğŸŸ¡ AMARELO</button>
        <button class="btn" id="red" title="Atalho: 3">ğŸ”´ VERMELHO</button>
        <button class="btn danger" id="clear">Limpar estado</button>
      </div>

      <p class="hint" style="margin-top:10px">
        Acessibilidade: alÃ©m de cor, cada estado tem â€œestampaâ€ (pontilhado / listras / hatch) + texto + Ã­cone.
        Atalhos: 1 (Verde), 2 (Amarelo), 3 (Vermelho).
      </p>

      <p class="hint">
        Este MVP salva no seu navegador (LocalStorage). Enquanto vocÃª nÃ£o cria um ClÃ£, o estado fica em â€œSem clÃ£â€.
        Depois, ele passa a funcionar por ClÃ£ automaticamente.
      </p>
    </section>

    <section class="card" style="margin-top:16px">
      <h2 style="margin:0">Do semÃ¡foro para a evidÃªncia</h2>
      <p style="margin:8px 0 0" class="small">
        Ã€s vezes a gente nÃ£o â€œdefineâ€ o estado â€” a gente <strong>descobre</strong>.
        PrÃ³ximo passo: sinais observÃ¡veis (sono, ingestÃ£o, dor, estÃ­mulo, rotina, episÃ³dios com timestamp)
        para sugerir o estado com base em evidÃªncias.
      </p>
    </section>
  </main>

  <script type="module">
    import {
      loadClans, loadActiveClanId, setActiveClanId,
      loadHouse, saveHouse, clearHouse, formatWhen
    } from "./assets/app.js";

    const updated = document.getElementById("updated");
    const badge = document.getElementById("badge");
    const label = document.getElementById("label");
    const clanName = document.getElementById("clanName");

    const btnG = document.getElementById("green");
    const btnY = document.getElementById("yellow");
    const btnR = document.getElementById("red");
    const btnC = document.getElementById("clear");

    function applyState(state){
      // fundo do site
      if (state) document.body.setAttribute("data-house", state);
      else document.body.removeAttribute("data-house");

      // badge
      badge.setAttribute("data-s", state || "YELLOW");
      label.textContent = state === "GREEN" ? "VERDE"
                        : state === "YELLOW" ? "AMARELO"
                        : state === "RED" ? "VERMELHO"
                        : "â€”";
    }

    function resolveClan(){
      const clans = loadClans();
      if (!clans.length){
        clanName.textContent = "ClÃ£: Sem clÃ£";
        return { id:"", name:"Sem clÃ£" };
      }
      const activeId = loadActiveClanId() || clans[0].id;
      const c = clans.find(x => x.id === activeId) || clans[0];
      setActiveClanId(c.id);
      clanName.textContent = "ClÃ£: " + (c.name || "Sem nome");
      return { id: c.id, name: c.name || "Sem nome" };
    }

    function render(){
      const clan = resolveClan();
      // fallback: se nÃ£o hÃ¡ clÃ£, usa storage â€œglobalâ€ (sem clanId)
      const h = loadHouse(clan.id);

      if (!h){
        applyState(null);
        updated.textContent = "Estado ainda nÃ£o definido.";
        return;
      }

      applyState(h.state);
      updated.textContent = "Atualizado em: " + formatWhen(h.updatedAt);
    }

    function setState(s){
      const clan = resolveClan();
      // permite salvar mesmo sem clÃ£ (id vazio)
      saveHouse(s, clan.id);
      render();
    }

    btnG.addEventListener("click", ()=> setState("GREEN"));
    btnY.addEventListener("click", ()=> setState("YELLOW"));
    btnR.addEventListener("click", ()=> setState("RED"));

    btnC.addEventListener("click", ()=>{
      const clan = resolveClan();
      clearHouse(clan.id);
      render();
    });

    window.addEventListener("keydown", (e)=>{
      if (e.target && (e.target.tagName === "INPUT" || e.target.tagName === "TEXTAREA" || e.target.tagName === "SELECT")) return;
      if (e.key === "1") setState("GREEN");
      if (e.key === "2") setState("YELLOW");
      if (e.key === "3") setState("RED");
    });

    render();
  </script>
</body>
</html>
